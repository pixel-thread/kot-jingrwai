name: EAS Production Deployment

# on:
#   push:
#     branches: ["master"]
#     paths:
#       - "src/apps/mobile/**"
#       - "src/packages/**/**"

jobs:
  fingerprint:
    name: ğŸ“‹ Calculate fingerprint
    type: fingerprint
    environment: production
    working_directory: src/apps/mobile

  check_existing_build:
    name: ğŸ” Check existing build
    type: get-build
    environment: production
    working_directory: src/apps/mobile
    needs: [fingerprint]
    params:
      fingerprint_hash: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
      profile: production

  build_new:
    name: ğŸ—ï¸ Create new build
    type: build
    environment: production
    working_directory: src/apps/mobile
    needs: [check_existing_build, fingerprint]
    if: ${{ !needs.check_existing_build.outputs.build_id && github.event_name != 'pull_request' }}
    params:
      platform: android
      profile: production

  publish_ota:
    name: âš¡ Publish OTA Update
    type: update
    environment: production
    working_directory: src/apps/mobile
    needs: [fingerprint]
    params:
      platform: android
      branch: production
      channel: production
      message: "UI/JS changes: ${{ github.event.head_commit.message }}"

  notify_summary:
    name: ğŸ“Š Deployment Summary
    type: slack
    needs: [build_new, publish_ota]
    if: ${{ always() }}
    params:
      webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
      message: |
        ğŸš€ PROD Deploy
        OTA: âœ… Always (UI/JS)
        Native Build: ${{ needs.build_new.outputs.build_id && 'âœ… New' || 'â Skipped' }}
        Fingerprint: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
