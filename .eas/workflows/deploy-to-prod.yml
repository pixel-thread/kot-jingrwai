name: EAS Production Deployment

on:
  push:
    branches: ['uat']

jobs:
  notify_start:
    name: ğŸš€ Notify deployment start
    type: slack
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸš€ PROD deployment started
        ```
          Branch: ${{ github.ref_name }}
          App: Kot-Jingrwai
          Platform: android
          channel: production
          Profile: production
          Commit: ${{ github.sha }}
        ```
  generate_build_db:
    name: ğŸ“‹ Generate build DB
    type: custom
    steps:
      - run: npx tsx scripts/seed-local-db.ts

  fingerprint:
    name: ğŸ“‹ Calculate fingerprint
    type: fingerprint
    environment: production
    needs: [notify_start, generate_build_db]

  notify_fingerprint:
    name: ğŸ“¤ Fingerprint calculated
    type: slack
    needs: [fingerprint]
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸ“‹ Fingerprint calculated: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
        Checking for existing build...

  check_existing_build:
    name: ğŸ” Check existing build
    type: get-build
    environment: production
    needs: [fingerprint]
    params:
      fingerprint_hash: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
      profile: production

  notify_build_check:
    name: ğŸ“Š Build check complete
    type: slack
    needs: [check_existing_build, fingerprint]
    if: ${{ always }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸ” Build check complete
        Build ID: ${{ needs.check_existing_build.outputs.build_id || 'None' }}
        Fingerprint: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}

  build_new:
    name: ğŸ—ï¸ Create new build
    type: build
    environment: production
    needs: [check_existing_build, fingerprint]
    if: ${{ !needs.check_existing_build.outputs.build_id }}
    params:
      platform: android
      profile: production

  notify_build_start:
    name: ğŸ—ï¸ Build started
    type: slack
    needs: [build_new, check_existing_build]
    if: ${{ !!needs.build_new.outputs.build_id }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸ—ï¸ NEW PRODUCTION BUILD started
        Build ID: ${{ needs.build_new.outputs.build_id }}
        Profile: production

  publish_update:
    name: âš¡ Publish OTA update
    type: update
    environment: production
    needs: [check_existing_build, fingerprint]
    if: ${{ !!needs.check_existing_build.outputs.build_id }}
    params:
      platform: android
      branch: production
      channel: production

  notify_update_start:
    name: âš¡ OTA update started
    type: slack
    needs: [publish_update, check_existing_build]
    if: ${{ !!needs.publish_update.outputs.update_group_id || !!needs.check_existing_build.outputs.build_id }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        âš¡ OTA UPDATE published
        Using existing build: ${{ needs.check_existing_build.outputs.build_id || 'None' }}
        Channel: production

  notify_success:
    name: âœ… Deployment successful
    type: slack
    needs: [build_new, publish_update, fingerprint]
    if: ${{ always }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        âœ… PROD deployment SUCCESS
        Build ID: ${{ needs.build_new.outputs.build_id || needs.check_existing_build.outputs.build_id || 'N/A' }}
        Fingerprint: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}

  notify_failure:
    name: âŒ Deployment failed
    type: slack
    needs: [fingerprint, check_existing_build, build_new, publish_update]
    if: ${{ failure }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        âŒ PROD deployment FAILED
        Build ID: ${{ needs.build_new.outputs.build_id || 'N/A' }}
        Existing Build ID: ${{ needs.check_existing_build.outputs.build_id || 'N/A' }}
        Fingerprint: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
