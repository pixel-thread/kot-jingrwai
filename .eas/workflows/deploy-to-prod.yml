name: EAS Production Deployment

on:
  push:
    branches: ['master']

jobs:
  notify-start:
    name: ğŸš€ Notify deployment start
    type: slack
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸš€ PROD deployment started
        Branch: ${{ github.ref_name }}
        App: ${{ github.event.repository.name }}
        Platform: android

  fingerprint:
    name: ğŸ“‹ Calculate fingerprint
    type: fingerprint
    environment: production
    needs: [notify-start]

  notify-fingerprint:
    name: ğŸ“¤ Fingerprint calculated
    type: slack
    needs: [fingerprint]
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸ“‹ Fingerprint calculated: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
        Checking for existing build...

  check-existing-build:
    name: ğŸ” Check existing build
    type: get-build
    environment: production
    needs: [fingerprint]
    params:
      fingerprint_hash: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}
      profile: production

  notify-build-check:
    name: ğŸ“Š Build check complete
    type: slack
    needs: [check-existing-build, fingerprint]
    if: always()
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸ” Build check complete
        Build exists: ${{ needs.check-existing-build.outputs.build_id && 'âœ… YES' || 'âŒ NO' }}
        Build ID: ${{ needs.check-existing-build.outputs.build_id || 'None' }}
        Fingerprint: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}

  build-new:
    name: ğŸ—ï¸ Create new build
    type: build
    environment: production
    needs: [check-existing-build, fingerprint]
    if: ${{ !needs.check-existing-build.outputs.build_id }}
    params:
      platform: android
      profile: production

  notify-build-start:
    name: ğŸ—ï¸ Build started
    type: slack
    needs: [build-new, check-existing-build]
    if: ${{ needs.build-new.result == 'success' }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        ğŸ—ï¸ NEW PRODUCTION BUILD started
        Build ID: ${{ needs.build-new.outputs.build_id }}
        Profile: production

  publish-update:
    name: âš¡ Publish OTA update
    type: update
    environment: production
    needs: [check-existing-build, fingerprint]
    if: ${{ !!needs.check-existing-build.outputs.build_id }}
    params:
      platform: android
      branch: production
      channel: production

  notify-update-start:
    name: âš¡ OTA update started
    type: slack
    needs: [publish-update, check-existing-build]
    if: ${{ needs.publish-update.result == 'success' }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        âš¡ OTA UPDATE published
        Using existing build: ${{ needs.check-existing-build.outputs.build_id }}
        Channel: production

  notify-success:
    name: âœ… Deployment successful
    type: slack
    needs: [build-new, publish-update, fingerprint]
    if: ${{ always() && (needs.build-new.result == 'success' || needs.publish-update.result == 'success') }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        âœ… PROD deployment SUCCESS
        ${{ needs.build-new.result == 'success' && 'ğŸ†• NEW BUILD: ' || 'âš¡ OTA UPDATE: ' }}
        Build ID: ${{ needs.build-new.outputs.build_id || needs.check-existing-build.outputs.build_id || 'N/A' }}
        Fingerprint: ${{ needs.fingerprint.outputs.android_fingerprint_hash }}

  notify-failure:
    name: âŒ Deployment failed
    type: slack
    needs: [fingerprint, check-existing-build, build-new, publish-update]
    if: ${{ failure() }}
    params:
      webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
      message: |
        âŒ PROD deployment FAILED
        Fingerprint: ${{ needs.fingerprint.result }}
        Build check: ${{ needs.check-existing-build.result }}
        Build: ${{ needs.build-new.result }}
        Update: ${{ needs.publish-update.result }}
